<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIMIQ - Phone Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .metric {
            text-align: center;
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }
        
        .metric:active {
            transform: scale(0.98);
        }
        
        .metric-value {
            font-size: 64px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-hr {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }
        
        .metric-hrv {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .metric-spo2 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 16px;
        }
        
        .status-idle {
            background: #f0f0f0;
            color: #666;
        }
        
        .status-monitoring {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .status-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            animation: shake 0.5s;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .info {
            text-align: center;
            color: white;
            font-size: 12px;
            margin-top: 20px;
            opacity: 0.8;
        }
        
        .alert-box {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-box h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .alert-box p {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .method-selector {
            margin-bottom: 20px;
        }
        
        .method-btn {
            padding: 12px;
            margin: 5px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .method-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ù§Ô∏è MIMIQ</h1>
            <p>Real-Time Cardiac Monitoring</p>
        </div>
        
        <div class="card">
            <div class="method-selector">
                <button class="method-btn active" onclick="selectMethod('camera')">üì∑ Camera PPG</button>
                <button class="method-btn" onclick="selectMethod('manual')">‚úã Manual Input</button>
            </div>
        </div>
        
        <div id="alertBox" class="alert-box">
            <h3>‚ö†Ô∏è Cardiac Event Detected!</h3>
            <p id="alertMessage"></p>
        </div>
        
        <div class="card">
            <div id="statusBar" class="status status-idle">
                Ready to Start
            </div>
            
            <div class="metric metric-hr">
                <div class="metric-value" id="heartRate">--</div>
                <div class="metric-label">Heart Rate (bpm)</div>
            </div>
            
            <div class="metric metric-hrv">
                <div class="metric-value" id="hrv">--</div>
                <div class="metric-label">HRV (ms)</div>
            </div>
            
            <div class="metric metric-spo2">
                <div class="metric-value" id="spo2">--</div>
                <div class="metric-label">SpO2 (%)</div>
            </div>
        </div>
        
        <div class="card" id="cameraSection" style="display: block;">
            <h3 style="margin-bottom: 15px; text-align: center;">Camera PPG Sensor</h3>
            <video id="video" width="100%" height="200" autoplay playsinline style="border-radius: 10px; background: black;"></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <p style="text-align: center; color: #666; margin-top: 10px; font-size: 12px;">
                Cover the camera with your fingertip
            </p>
        </div>
        
        <div class="card" id="manualSection" style="display: none;">
            <h3 style="margin-bottom: 15px;">Manual Input</h3>
            <input type="number" id="manualHR" placeholder="Heart Rate (bpm)" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
            <input type="number" id="manualHRV" placeholder="HRV (ms)" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
            <input type="number" id="manualSpO2" placeholder="SpO2 (%)" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        </div>
        
        <button id="startBtn" class="btn btn-start" onclick="toggleMonitoring()">
            START MONITORING
        </button>
        
        <div class="info">
            <p id="patientId">Patient ID: PHONE_USER_####</p>
            <p>Backend: Connected ‚úÖ</p>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = window.location.origin + '/api/vitals';
        const PATIENT_ID = 'PHONE_USER_' + Math.random().toString(36).substr(2, 8).toUpperCase();
        
        // State
        let isMonitoring = false;
        let currentMethod = 'camera';
        let stream = null;
        let monitoringInterval = null;
        let ppgInterval = null;
        
        // Camera PPG variables
        let redValues = [];
        const PPG_SAMPLE_SIZE = 30;
        
        // Initialize
        document.getElementById('patientId').textContent = `Patient ID: ${PATIENT_ID}`;
        
        // Method selector
        function selectMethod(method) {
            currentMethod = method;
            
            // Update buttons
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide sections
            if (method === 'camera') {
                document.getElementById('cameraSection').style.display = 'block';
                document.getElementById('manualSection').style.display = 'none';
            } else {
                document.getElementById('cameraSection').style.display = 'none';
                document.getElementById('manualSection').style.display = 'block';
            }
        }
        
        // Toggle monitoring
        async function toggleMonitoring() {
            if (!isMonitoring) {
                await startMonitoring();
            } else {
                stopMonitoring();
            }
        }
        
        // Start monitoring
        async function startMonitoring() {
            isMonitoring = true;
            updateStatus('Monitoring...', 'monitoring');
            
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = 'STOP MONITORING';
            startBtn.classList.remove('btn-start');
            startBtn.classList.add('btn-stop');
            
            if (currentMethod === 'camera') {
                await startCameraPPG();
            } else {
                startManualMonitoring();
            }
        }
        
        // Stop monitoring
        function stopMonitoring() {
            isMonitoring = false;
            updateStatus('Stopped', 'idle');
            
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = 'START MONITORING';
            startBtn.classList.remove('btn-stop');
            startBtn.classList.add('btn-start');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            if (ppgInterval) {
                clearInterval(ppgInterval);
                ppgInterval = null;
            }
        }
        
        // Camera PPG
        async function startCameraPPG() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // Start PPG analysis
                ppgInterval = setInterval(analyzePPG, 100); // 10 Hz sampling
                
                // Send data every 5 seconds
                monitoringInterval = setInterval(sendCameraPPGData, 5000);
                
            } catch (error) {
                console.error('Camera error:', error);
                alert('Camera access denied. Please allow camera permission and try again.');
                stopMonitoring();
            }
        }
        
        function analyzePPG() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            
            // Calculate average red channel (blood absorbs green, reflects red)
            let redSum = 0;
            for (let i = 0; i < pixels.length; i += 4) {
                redSum += pixels[i]; // Red channel
            }
            const avgRed = redSum / (pixels.length / 4);
            
            redValues.push(avgRed);
            if (redValues.length > PPG_SAMPLE_SIZE) {
                redValues.shift();
            }
            
            // Calculate heart rate from red channel variations
            if (redValues.length === PPG_SAMPLE_SIZE) {
                const hr = calculateHeartRate(redValues);
                const hrv = calculateHRV(redValues);
                
                document.getElementById('heartRate').textContent = Math.round(hr);
                document.getElementById('hrv').textContent = Math.round(hrv);
                document.getElementById('spo2').textContent = Math.round(95 + Math.random() * 3); // Simulated
            }
        }
        
        function calculateHeartRate(values) {
            // Simple peak detection
            let peaks = 0;
            for (let i = 1; i < values.length - 1; i++) {
                if (values[i] > values[i-1] && values[i] > values[i+1]) {
                    if (values[i] > (Math.max(...values) * 0.6)) {
                        peaks++;
                    }
                }
            }
            
            // Convert to BPM (sampling at 10 Hz for 3 seconds)
            const bpm = (peaks / (PPG_SAMPLE_SIZE * 0.1)) * 60;
            return Math.max(50, Math.min(180, bpm)); // Clamp to realistic range
        }
        
        function calculateHRV(values) {
            // Simplified HRV calculation (standard deviation of intervals)
            const intervals = [];
            for (let i = 1; i < values.length; i++) {
                intervals.push(Math.abs(values[i] - values[i-1]));
            }
            
            const mean = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const variance = intervals.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / intervals.length;
            return Math.sqrt(variance) * 10; // Scale to ms
        }
        
        function sendCameraPPGData() {
            const hr = parseInt(document.getElementById('heartRate').textContent) || 0;
            const hrv = parseInt(document.getElementById('hrv').textContent) || 0;
            const spo2 = parseInt(document.getElementById('spo2').textContent) || 0;
            
            if (hr > 0) {
                sendToBackend({
                    heart_rate: hr,
                    hrv_rmssd: hrv,
                    spo2: spo2
                });
            }
        }
        
        // Manual monitoring
        function startManualMonitoring() {
            monitoringInterval = setInterval(() => {
                const hr = parseInt(document.getElementById('manualHR').value) || 72;
                const hrv = parseInt(document.getElementById('manualHRV').value) || 65;
                const spo2 = parseInt(document.getElementById('manualSpO2').value) || 98;
                
                document.getElementById('heartRate').textContent = hr;
                document.getElementById('hrv').textContent = hrv;
                document.getElementById('spo2').textContent = spo2;
                
                sendToBackend({
                    heart_rate: hr,
                    hrv_rmssd: hrv,
                    spo2: spo2
                });
            }, 5000);
        }
        
        // Send to backend
        async function sendToBackend(vitals) {
            const data = {
                patient_id: PATIENT_ID,
                timestamp: Date.now() / 1000,
                data_source: currentMethod === 'camera' ? 'phone_camera_ppg' : 'phone_manual',
                ...vitals
            };
            
            console.log('üì§ Sending:', data);
            
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('üì• Response:', result);
                
                if (result.is_anomaly) {
                    showAlert(result);
                }
                
            } catch (error) {
                console.error('‚ùå Send error:', error);
            }
        }
        
        // Show alert
        function showAlert(data) {
            const alertBox = document.getElementById('alertBox');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.innerHTML = `
                <strong>Diagnosis:</strong> ${data.diagnosis}<br>
                <strong>Risk Level:</strong> ${data.risk_level}<br>
                <strong>Confidence:</strong> ${data.confidence}%
            `;
            
            alertBox.style.display = 'block';
            updateStatus('‚ö†Ô∏è ALERT!', 'alert');
            
            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            // Hide after 10 seconds
            setTimeout(() => {
                alertBox.style.display = 'none';
                updateStatus('Monitoring...', 'monitoring');
            }, 10000);
        }
        
        // Update status
        function updateStatus(text, type) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = text;
            statusBar.className = `status status-${type}`;
        }
    </script>
</body>
</html>
